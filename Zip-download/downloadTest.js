const  _ = require('lodash') 
const archiver = require('archiver')
var express = require('express');
var wait=require('wait.for');
var app = express();
// var fs = require('fs');
var c= 0;



        // Routing download zip files.
        app.get('/download', async (req, res) => {
            const zip = archiver('zip'
            // , {
            //     zlib: { level: 9 } // Sets the compression level.
            //   }
              );
            res.attachment('SurgeSend.zip');
            zip.pipe(res);

        // var fileKey ='pankaj/3100350036003500360037003200390034003500380036003100350074006500730074003100300030006D00620032002E00740078007400.txt';
        // console.log(req)
        // var fileKey = ['31003500360034003900390037003200300032003600380032003100520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003200340020002D00200043006F006D0070006F006E0065006E00740020005500700064006100740069006E00670020004C006900660065006300790063006C00650020004D006500740068006F00640073002E006D0070003400.mp4'
        //                 , '31003500360034003900390037003200310031003900330035003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003200350020002D00200046007200610067006D0065006E00740073002E006D0070003400.mp4']    
        
        //750mb
        // var fileKey = [
        //     '3100350036003500320036003000330037003400350035003000300074006500730074003200350030006D00620032002E00740078007400.txt',
        //     '3100350036003500320036003000340036003500340033003200390074006500730074003200350030006D00620033002E00740078007400.txt',
        //     '3100350036003500320036003000350034003800390039003300330074006500730074003200350030006D00620034002E00740078007400.txt'
        // ]

        //1.1 gb
        // var fileKey = [
        //     '31003500360037003400390030003400320035003300360034003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300310020002D00200050006F007200740061006C0073002E006D0070003400.mp4',
        //     '31003500360037003400390030003400340032003300390035003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300320020002D0020004500720072006F007200200042006F0075006E0064006100720079002E006D0070003400.mp4',
        //     '3100350036003700340039003000340035003300350038003500370076006900640065006F0070006C00610079006200610063006B002E006D0070003400.mp4',
        //     '310035003600370034003900300035003500360036003500330039004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
        // ]



        // var fileKey = [
        //     '31003500360038003100300035003900390031003400320037003100520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300310020002D00200050006F007200740061006C0073002E006D0070003400.mp4',
        //     '31003500360038003100300036003000300035003100380031003400520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300300020002D00200046006F007200770061007200640069006E006700200052006500660073002E006D0070003400.mp4',
        //     '31003500360038003100300036003000310033003500340030003200520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003200390020002D002000520065006600730020007700690074006800200043006C00610073007300200043006F006D0070006F006E0065006E00740073002E006D0070003400.mp4',
        // '31003500360038003100300036003000320031003600340031003200520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300320020002D0020004500720072006F007200200042006F0075006E0064006100720079002E006D0070003400.mp4'
        // ]
        
        //11 gb 3 files arjun reddy
        // var fileKey = [
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
        // ]



            // 11 gb diff files
            // var fileKey = [
            //       '310035003600380036003100380033003600320035003600390033007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
            //       '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
            //       ,
            //       '3100350036003800360032003000360036003200320039003300360074006500730074003200670062002E00740078007400.txt',
            //       '3100350036003800360032003100370037003800300035003200350074006500730074002E00740078007400.txt',
            //       '310035003600380036003200320035003400320035003300320037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
            //   ]

            //testing above files by changing order of files
            const fileKey = [

              '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4',
              '310035003600380036003100380033003600320035003600390033007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
              '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4',
              '310035003600380036003100380033003600320035003600390033007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
              // ,
              // '3100350036003800360032003000360036003200320039003300360074006500730074003200670062002E00740078007400.txt'
              // ,
              // '3100350036003800360032003100370037003800300035003200350074006500730074002E00740078007400.txt',
              // '310035003600380036003200320035003400320035003300320037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
          ]

        // console.log('Trying to download file', fileKey);

//         fileKey.forEach(async function(f){

//         // res.send({"ok":fileKey});
//         const AWS = require('aws-sdk');
//         AWS.config.update(
//           {
//             accessKeyId: "AKIASDPWCZPFY4KAZH7D",
//             secretAccessKey: "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",
//             region: 'us-east-1'

//           }
//         );
//         const s3 = new AWS.S3();
//         const options = {
//             Bucket    : 'dev.static.surgesend.com',
//             Key    : f,
//         };
        
//         // const fileStream = 
//         c++;
//         const fileObject = download(s3,options)
//         console.log("after increment counting-----------------------------------------------")
//         console.log(c)
//         console.log("create after append -----------------------------------------------")
//         // console.log(fileStream)
//         await zip.append( fileObject , { name: "videoplayback"+c+".mp4" });
//         console.log("create ZIP append -----------------------------------------------")
 


// })

_.each(fileKey, async (file) => {

        const AWS = require('aws-sdk');
        AWS.config.update(
          {
            accessKeyId: "AKIASDPWCZPFY4KAZH7D",
            secretAccessKey: "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",
            region: 'us-east-1'
            ,
              httpOptions: {
                timeout: 9000000 // 15 minutes
              }

          }
        );
        const s3 = new AWS.S3();
        const options = {
            Bucket    : 'dev.static.surgesend.com',
            Key    : file,
        };


  const fileObject =  download(s3,options);
  console.log("fileObject")
    c++
  zip.append(fileObject,  { name: "videoplayback"+c+".mp4" });
  console.log("fileObject wait for------")


  /*const filePath = path.join(uploadDir, _.get(file, 'name'));
  zip.file(filePath, {name: _.get(file, 'originalName')});*/


});

    
           await zip.finalize();
            console.log("after finalizeeeeeeeeeeeeeeeeeeeeee-------------------")
        });

         const  download =  (s3,options)  => {


          console.log("in function call");
  
         return s3.getObject(options).createReadStream();
          
          // console.log(options);
          // // res.attachment("test.txt");
          // return  s3.getObject(options).createReadStream();

          console.log("get object ------------------------------------------------------------")
          console.log(c)
          // console.log(s3.getObject(options));
  
  
          // try {
          //    return new Promise( (resolve, reject) => {
          //     const response =  s3.getObject(options).createReadStream()
          //     console.log("promise start")
          //     response.on('error', reject)
          //     response.on('end', resolve)
          //     zip.append( response, { name: "videoplayback"+c+".mp4" });
          //     console.log("promise end")
          //   })

          // } catch (err) {
          //   throw new Error(`request  failed in ms: ${err.stack}`)
          // }



           
         
           c++;
          console.log("create after append -----------------------------------------------object")
        }




        var server = app.listen(6002, function () {
            var port = server.address().port;
            console.log('Server is running on port <<<<--->>>>', port);
        });


        