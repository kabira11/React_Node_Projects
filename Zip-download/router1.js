// const  _ = require('lodash') 
const archiver = require('archiver')
var express = require('express');
const jwt = require('jsonwebtoken')
var app = express();
var DBInstance = require('./sever');
var c= 1;
// DBInstance.connect();
// var fs = require('fs');



        // Routing download zip files.
        app.get('/download', async (req, res) => {


          // DBInstance.db.query('select id, user_id, email, uname, user_type, s_id, referral_template_id from users.users where email = "pankaj@happaround.me" AND is_active =true')
          // .then((res)=> {
          //     console.log(res)
          // })
          // .catch(e =>{
          //     console.log(e)
          // })

            const zip = archiver('zip');
            // res.attachment('SurgeSend.zip');
            // zip.pipe(res);

            zip
            .on('error', (err) => {
              console.log('archive error', err);
            })
            .on('entry', entry => {
              console.log('archive event: entry ', entry.name);
            })
            .on('progress', data => {
              console.log('archive event: progress', data);
            })
            .on('data', data => {
            //   console.log(`archive event: data | processed total ${(zip.pointer() / (1024 ** 2)).toFixed(3)} MB | data length: ${data.length}`);
            });
        
          res.setHeader('Content-disposition', `attachment; filename*=UTF-8''SurgeSend.zip; filename=SurgeSend.zip`);
          res.setHeader('Content-type', 'application/zip');
        
          zip.pipe(res);
   
      var fileKey = [
            '31003500360037003400390030003400320035003300360034003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300310020002D00200050006F007200740061006C0073002E006D0070003400.mp4',
            '31003500360037003400390030003400340032003300390035003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300320020002D0020004500720072006F007200200042006F0075006E0064006100720079002E006D0070003400.mp4',
            '3100350036003700340039003000340035003300350038003500370076006900640065006F0070006C00610079006200610063006B002E006D0070003400.mp4',
            '310035003600370034003900300035003500360036003500330039004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
        ]


            // 11 gb diff files
            // var fileKey = [
            //   '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
            //   ,
            //       '310035003600380036003100380033003600320035003600390033007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',

            //     '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4',
            //     //   '3100350036003800360032003000360036003200320039003300360074006500730074003200670062002E00740078007400.txt',
            //     //   '3100350036003800360032003100370037003800300035003200350074006500730074002E00740078007400.txt',
            //       '310035003600380036003200320035003400320035003300320037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
            //   ]
        // var fileKey = [
        //     '31003500360037003400390030003400320035003300360034003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300310020002D00200050006F007200740061006C0073002E006D0070003400.mp4',
        //     '31003500360037003400390030003400340032003300390035003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300320020002D0020004500720072006F007200200042006F0075006E0064006100720079002E006D0070003400.mp4',
        //     '3100350036003700340039003000340035003300350038003500370076006900640065006F0070006C00610079006200610063006B002E006D0070003400.mp4',
        //     '310035003600370034003900300035003500360036003500330039004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
        // ]


      //11 gb 3 files arjun reddy
        // var fileKey = [
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
        //     '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
        // ]
        
  
        try {
            const downloads = []

         

        for (let i = 0; i < fileKey.length; i++) {
            
            await  download(c++, zip , fileKey[i])
          }
        // await Promise.all(downloads)

        // await Promise.all(downloads)
        
            zip.finalize()
          } catch (err) {
            console.error(err)
          }

        });

        async function download (c, zip , f) {
            try {
              await new Promise((resolve, reject) => {
                console.log("pankaj india imnoamsj snsjsnnss")
                console.log(f)
                var AWS = require('aws-sdk');
                AWS.config.update(
                  {
                    accessKeyId: "AKIASDPWCZPFY4KAZH7D",
                    secretAccessKey: "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",
                    region: 'us-east-1'
                  }
                );
                var s3 = new AWS.S3();
                var options = {
                    Bucket    : 'dev.static.surgesend.com',
                    Key    : f,
                };
                
                const response = s3.getObject(options).createReadStream()
                console.log("after getobject counter is--------------"+c)
                response.on('error', reject)
                console.log("after error ------------------------")
                response.on('end', resolve)
                console.log("after resolve     ------------------------")
                // ;
                zip.append(response, { name: "videoplayback"+ c +".mp4" })
                console.log("after append ------------------------")
              })

            } catch (err) {
                console.log(`counter c when downloading fails c === ${c}`)
              throw new Error(`request failed in catch block`)
            }
          }
          
          
          const myFunction1 = async () => {
            
            //creating token
            //expiresIn set expire of web token
            const token = jwt.sign(
              {
                _id: 'abcd123',
                fileName: [
                  '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
                  '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
              ]
              } ,
              'thisismysecretkey',
              {expiresIn: '7 days'}
              )
            console.log("token")
            console.log(token)
            /*
            After that last period to the very end of the Jason Webb token we have the signature.
        
            And this is used to verify the token later on when we verify it.
            */
            //eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiJhYmNkMTIzIiwiaWF0IjoxNTY4NjU2NTk4fQ.S_1woo_2XpWuRc8OwDsp1ppVXXNifG8H7eToBco2yBs
         
        
            //verify token -- data
            const data = jwt.verify(token,'thisismysecretkey')
            console.log(data.fileName)
        }

        // myFunction1()

        var server = app.listen(6004, function () {
            var port = server.address().port;
            console.log('Server is running on port <<<<--->>>>', port);
        });


        