const archiver = require('archiver')
var express = require('express');
var app = express();
const jwt = require('jsonwebtoken')
var counter = 1;

        // Routing download zip files.
        app.get('/download', async (req, res) => {
            const zip = archiver('zip');

            zip
            .on('error', (err) => {
              console.log('archive error', err);
            })
            .on('entry', entry => {
              console.log('archive event: entry ', entry.name);
            })
            .on('progress', data => {
              console.log('archive event: progress', data);
            })
            .on('data', data => {
            	//
            });
        
            res.setHeader('Content-disposition', `attachment; filename*=UTF-8''SurgeSend.zip; filename=SurgeSend.zip`);
            res.setHeader('Content-type', 'application/zip');
        
            zip.pipe(res);
   

            // 11 gb diff files
            var fileKey = [
              '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
              ,
              '310035003600380036003100380033003600320035003600390033007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
              '310035003600380036003200300033003400320032003300320035004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4',
              '3100350036003800360032003000360036003200320039003300360074006500730074003200670062002E00740078007400.txt',
              '3100350036003800360032003100370037003800300035003200350074006500730074002E00740078007400.txt'
              ]
            
            
            // var fileKey = [
            //     '31003500360037003400390030003400320035003300360034003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300310020002D00200050006F007200740061006C0073002E006D0070003400.mp4',
            //     '31003500360037003400390030003400340032003300390035003300520065006100630074004A00530020005400750074006F007200690061006C0020002D0020003300320020002D0020004500720072006F007200200042006F0075006E0064006100720079002E006D0070003400.mp4',
            //     '3100350036003700340039003000340035003300350038003500370076006900640065006F0070006C00610079006200610063006B002E006D0070003400.mp4',
            //     '310035003600370034003900300035003500360036003500330039004100720063007400690063002E0032003000310038002E0037003200300070002E0042006C0075005200610079002E0078003200360034002D005B005900540053002E0041004D005D002E006D0070003400.mp4'
            // ]


            //52 gb files tested.....
	        // var fileKey = [
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100320033003600380033003100340037007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
	        //     '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
	        // ]
        
  
	        try {
	        	
		        for (let i = 0; i < fileKey.length; i++) {
		        	
		            await download(counter++, zip , fileKey[i])
		            
		          }
	        
	            zip.finalize()
	          } catch (err) {
	            console.error(err)
	          }

        });


        async function download (counter, zip , f) {
            try {
              await new Promise((resolve, reject) => {
                var AWS = require('aws-sdk');
                AWS.config.update(
                  {
                    accessKeyId: "AKIASDPWCZPFY4KAZH7D",
                    secretAccessKey: "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",
                    region: 'us-east-1'
                  }
                );
                var s3 = new AWS.S3();
                var options = {
                    Bucket    : 'dev.static.surgesend.com',
                    Key    : f,
                };
                
                const response = s3.getObject(options).createReadStream()
                response.on('error', reject)
                response.on('end', resolve)
                // Hard coded value for file name.......
                zip.append(response, { name: "videoplayback"+ counter +".mp4" })
              })

            } catch (err) {
              throw new Error(`request failed in catch block`)
            }
          }
          
    	const decodeToken = async () => {
            
            //creating token
            //expiresIn set expire of web token
            const token = jwt.sign(
              {
                _id: 'abcd123',
                fileName: [
                  '310035003600380031003100300039003600340037003600300030007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4',
                  '310035003600380031003100330038003700330037003600350032007700770077002E00540061006D0069006C004D0056002E007200650020002D002000410072006A0075006E0020005200650064006400790020002800320030003100370029002000540065006C007500670075002000280055006E00630065006E0073006F00720065006400290020002D0020005700450042002D004800440020002D0020003100300038003000700020002D00200041005600430020002D00200041004100430020002D00200033002E0037004700420020002D00200045005300750062002E006D0070003400.mp4'
              ]
              } ,
              'thisismysecretkey',
              {expiresIn: '7 days'}
              )
            console.log("token")
            console.log(token)
         
        
            //verify token -- data
            const data = jwt.verify(token,'thisismysecretkey')
            console.log(data.fileName)
        }

    	// decodeToken()





        var server = app.listen(6004, function () {
            var port = server.address().port;
            console.log('Server is running on port <<<<--->>>>', port);
        });


        